name: Generate custom GMS image

on:
  workflow_dispatch:

jobs:
  build-gms:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3 

      - name: Install JDK8
        run: |
          sudo apt-get -y remove temurin-11-jdk --purge 
          sudo apt-get -y remove temurin-17-jdk --purge
          java -version
          JAVA_HOME=/usr/lib/jvm/temurin-8-jdk-amd64
          echo $JAVA_HOME


      - name: Install Gradle
        run: |
          sudo apt install snapd -y 
          sudo snap install gradle --classic
          gradle --version 

      - name: Install Docker
        run: |
          sudo apt-get -y remove docker docker-engine docker.io 
          sudo apt-get update
          sudo apt install apt-transport-https curl gnupg-agent ca-certificates software-properties-common -y
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
          sudo apt install docker-ce docker-ce-cli containerd.io -y
          sudo usermod -aG docker $USER
          newgrp docker
          docker --version

      - name: Build gms 
        run: |
          ./gradlew :metadata-service:war:build 

      - name: Build docker image 
        run: |
          cd docker/datahub-gms
          docker build -t ssogunletc/datahub-gms:v0.10.2 . 
          

      - name: List docker images 
        run: | 
          docker images  

      - name: Push image to Dockerhub 
        run: |
          docker login -u=" ${{ secrets.DOCKER_USER }}" -p=" ${{ secrets.DOCKER_PASSWORD }}"
          docker push ssogunletc/datahub-gms:v0.10.2  